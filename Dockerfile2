#
# SPDX-License-Identifier: Apache-2.0
#
FROM couchdb:3.1.2 AS base

ENV DEBIAN_FRONTEND=noninteractive 

# # Build tools
 RUN apt-get update \    
     && apt-get -y install build-essential gcc gzip \
     && apt-get -y install python3 python3-distutils libpython3-dev software-properties-common \   
     && apt-get -y install curl git jq unzip moreutils
ADD docker/local.ini /opt/couchdb/etc/local.d/local.ini
# https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.16.1%2B1/OpenJDK11U-jdk_x64_linux_hotspot_11.0.16.1_1.tar.gz
# https://github.com/adoptium/temurin11-binaries/releases/download/jdk-11.0.16.1%2B1/OpenJDK11U-jdk_arm_linux_hotspot_11.0.16.1_1.tar.gz

RUN mkdir -p /opt/go /opt/node /opt/java \
    && curl -sSL https://dl.google.com/go/go1.17.2.linux-amd64.tar.gz | tar xzf - -C /opt/go --strip-components=1 \
    && curl -sSL https://github.com/AdoptOpenJDK/openjdk11-binaries/releases/download/jdk-11.0.7%2B10/OpenJDK11U-jdk_x64_linux_hotspot_11.0.7_10.tar.gz | tar xzf - -C /opt/java --strip-components=1 \
    && curl -sSL https://nodejs.org/download/release/v16.4.0/node-v16.4.0-linux-x64.tar.xz | tar xJf - -C /opt/node --strip-components=1
ENV GOROOT=/opt/go
ENV GOCACHE=/tmp/gocache
ENV GOENV=/tmp/goenv
ENV GOPATH=/tmp/go
ENV JAVA_HOME=/opt/java
ENV MAVEN_OPTS="-Dmaven.repo.local=/tmp/maven"
ENV npm_config_cache=/tmp/npm-cache
ENV npm_config_devdir=/tmp/npm-devdir
ENV PATH=/opt/go/bin:/opt/node/bin:/opt/java/bin:${PATH}
RUN curl -sSL -o /tmp/gradle.zip https://services.gradle.org/distributions/gradle-5.6.4-bin.zip \
    && unzip -qq /tmp/gradle.zip -d /opt \
    && mkdir -p /opt/gradle/bin \
    && cd /opt/gradle/bin       \
    && /opt/gradle-5.6.4/bin/gradle wrapper \
    && rm -f /tmp/gradle.zip \
    && rm -rf /opt/gradle-5.6.4 \
    && cd - \
    && curl -sSL https://downloads.apache.org/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz | tar xzf - -C /opt \
    && mv /opt/apache-maven-3.6.3 /opt/maven
ENV PATH=/opt/gradle/bin:/opt/maven/bin:${PATH}
ADD builders/java/pom.xml /opt/fabric-chaincode-java/
RUN mkdir -p /opt/fabric \
    && curl -sSL https://github.com/hyperledger/fabric/releases/download/v2.4.6/hyperledger-fabric-linux-amd64-2.4.6.tar.gz | tar xzf - -C /opt/fabric  \
    && curl -sSL https://github.com/hyperledger/fabric-ca/releases/download/v1.5.2/hyperledger-fabric-ca-linux-amd64-1.5.2.tar.gz | tar xzf - -C /opt/fabric  \
    && cd /opt/fabric-chaincode-java \
    # && mvn -q dependency:copy-dependencies -DoutputDirectory=/opt/fabric-chaincode-java/lib \
    && npm install --unsafe-perm -g fabric-shim@2.4.2 \
    && rm -rf /tmp/gocache /tmp/goenv /tmp/go /tmp/maven /tmp/npm-cache /tmp/npm-devdir
ENV FABRIC_CFG_PATH=/opt/fabric/config 
ENV PATH=/opt/fabric/bin:${PATH}


FROM base AS builder
ADD . /tmp/microfab
RUN cd /tmp/microfab \
    && mkdir -p /opt/microfab/bin /opt/microfab/data \
    && chgrp -R root /opt/microfab/data \
    && chmod -R g=u /opt/microfab/data \
    && go build -o /opt/microfab/bin/microfabd cmd/microfabd/main.go \
    && cp -rf builders /opt/microfab/builders

FROM base
COPY --from=builder /opt/microfab /opt/microfab
COPY --from=base /opt/fabric/builders/ccaas /opt/microfab/builders/ccaas
COPY docker/docker-entrypoint.sh /
ENV MICROFAB_HOME=/opt/microfab
ENV PATH=/opt/microfab/bin:/opt/couchdb/bin:${PATH}
EXPOSE 8080
USER 7051
VOLUME /opt/microfab/data
ENTRYPOINT [ "tini", "--", "/docker-entrypoint.sh" ]
